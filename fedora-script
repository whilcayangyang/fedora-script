#!/bin/bash
user=$(whoami)
laptop=$(hostnamectl chassis | grep laptop)
desktop=$(hostnamectl chassis | grep desktop)

# optimize DNF download
sudo sh -c "echo 'max_parallel_downloads=10' | tee -a /etc/dnf/dnf.conf > /dev/null"

# system upgrade
sudo dnf upgrade -y

# install/remove necessary package
sudo dnf install -y gnome-shell-extension-system-monitor-applet \
			gnome-shell-extension-blur-my-shell \
			gnome-shell-extension-freon \
			adw-gtk3-theme \
			papirus-icon-theme \
			thunderbird
sudo dnf autoremove -y libreoffice-core

# install kvm virtualization
sudo dnf install -y bridge-utils libvirt virt-install virt-manager qemu-kvm
sudo usermod -aG libvirt $user
sudo systemctl start libvirtd
sudo systemctl enable libvirtd

# remove gnome-boxes
sudo dnf autoremove -y gnome-boxes

# laptop battery optimize
if [ $laptop ]; then
	sudo dnf remove -y power-profiles-daemon
	sudo dnf install -y tlp tlp-rdw
	sudo systemctl enable --now tlp.service
	sudo systemctl mask systemd-rfkill.service
	sudo systemctl mask systemd-rfkill.socket
else
	echo "Nothing to do!"; sleep 2
fi

# install gns3 on Desktop
if [ $desktop ]; then
	sudo dnf install -y gns3-gui gns3-server wireshark
	sudo usermod -aG kvm,wireshark $user
else
	echo "Nothing to do!"; sleep 2
fi

# install fedora docker-ce
sudo dnf remove -y docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-selinux \
                  docker-engine-selinux \
                  docker-engine
sudo dnf install -y dnf-plugins-core
sudo dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo
sudo dnf install -y docker-ce \
		docker-ce-cli \
		containerd.io \
		docker-buildx-plugin \
		docker-compose-plugin
sudo systemctl enable --now docker
sudo usermod -aG docker $user

# enable flatpak flathub and disable fedora flatpak
sudo flatpak remote-modify --disable fedora
sudo flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
sudo flatpak remote-modify --enable flathub

# Gnome Software make flatpak as default
gsettings set org.gnome.software packaging-format-preference "['flatpak', 'rpm']"

# install gtk3 themes, GIMP, Transmission, Calibre, LibreOffice, Flatseal, Discord, Drawio
flatpak install --noninteractive flathub org.gtk.Gtk3theme.adw-gtk3 org.gtk.Gtk3theme.adw-gtk3-dark org.gimp.GIMP com.transmissionbt.Transmission com.calibre_ebook.calibre org.libreoffice.LibreOffice com.github.tchx84.Flatseal com.discordapp.Discord com.jgraph.drawio.desktop

# install microsoft fonts & multimedia codes
sudo dnf install -y curl \
		cabextract \
		xorg-x11-font-utils \
		fontconfig
sudo rpm -ivh https://downloads.sourceforge.net/project/mscorefonts2/rpms/msttcore-fonts-installer-2.6-1.noarch.rpm
sudo dnf install -y gstreamer1-plugins-{bad-\*,good-\*,base} gstreamer1-plugin-openh264 gstreamer1-plugin-libav --exclude=gstreamer1-plugins-bad-free-devel
sudo dnf install -y lame\* --exclude=lame-devel
sudo dnf group upgrade -y --with-optional Multimedia

# install OhMyZsh
sudo dnf install -y zsh \
		powerline-fonts \
		zsh-autosuggestions \
		zsh-syntax-highlighting \
		neofetch
sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
sed -i '/source $ZSH\/oh-my-zsh.sh/ a\source \/usr\/share\/zsh-autosuggestions\/zsh-autosuggestions.zsh' ~/.zshrc
sed -i '/source $ZSH\/oh-my-zsh.sh/ a\source \/usr\/share\/zsh-syntax-highlighting\/zsh-syntax-highlighting.zsh' ~/.zshrc
sed -i 's/plugins=(git)/plugins=(docker firewalld dnf systemd sudo)/' ~/.zshrc
sed -i '$a\neofetch --color_blocks off' ~/.zshrc
